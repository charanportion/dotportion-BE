org: dotportion
service: dotportion-realtime-api

custom:
  prune:
    automatic: true
    number: 2

  domains:
    dev: api-dev.dotportion.com
    uat: api-uat.dotportion.com
    prod: api.dotportion.com

  customDomain:
    domainName: ${self:custom.domains.${self:provider.stage}}
    stage: ${self:provider.stage}
    basePath: realtime
    createRoute53Record: false
    endpointType: regional

  authorizerArn: ${cf:dotportion-auth-api-${self:provider.stage}.AuthorizerArn}

provider:
  name: aws
  runtime: nodejs18.x
  region: ap-south-1
  stage: ${opt:stage, 'dev'}

  environment:
    # Stage
    STAGE: ${self:provider.stage}
    NODE_ENV: ${self:provider.stage}

    # Database
    MONGO_URI: ${ssm:/dotportion/${self:provider.stage}/mongo_uri}
    MDataBase: ${self:provider.stage}

    # Orchestrator
    ORCHESTRATOR_FUNCTION_NAME: ${self:service}-${self:provider.stage}-orchestrator

    # ✅ FIXED: use Ref instead of ImportValue
    WEBSOCKET_API_ID:
      Ref: WebsocketsApi

    AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1

  iamRoleStatements:
    # SSM access
    - Effect: Allow
      Action:
        - ssm:GetParameter
      Resource:
        - arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/dotportion/${self:provider.stage}/*

    # Logs
    - Effect: Allow
      Action:
        - logs:CreateLogGroup
        - logs:CreateLogStream
        - logs:PutLogEvents
      Resource: arn:aws:logs:${aws:region}:${aws:accountId}:*

functions:
  # ==========================
  # HTTP API – Start Workflow
  # ==========================
  startWorkflow:
    handler: startWorkflow.handler
    iamRoleStatements:
      - Effect: Allow
        Action:
          - lambda:InvokeFunction
        Resource:
          - arn:aws:lambda:${aws:region}:${aws:accountId}:function:${self:service}-${self:provider.stage}-orchestrator

    events:
      - http:
          path: /{projectId}/{tenant}/execute
          method: post
          cors:
            origins:
              - "http://localhost:3000" # For local development
              - "https://www.dotportion.com/"
              - "https://no-code-api-builder-edby86tby-sri-charans-projects.vercel.app/"
              - "https://uat.dotportion.com"
              - "https://beta.dotportion.com"
              - "https://uat.d34dhbi3es40ie.amplifyapp.com"
              - "https://beta.d34dhbi3es40ie.amplifyapp.com"
            headers: # Optional: specify allowed headers
              - Content-Type
              - Authorization
              - X-Amz-Date
              - X-Api-Key
              - X-Amz-Security-Token
            allowCredentials: true
          authorizer:
            type: token
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 300
            arn: ${self:custom.authorizerArn}

  # ==========================
  # WebSocket – Connection
  # ==========================
  connectionManager:
    handler: connectionManager.handler
    events:
      - websocket:
          route: $connect
      - websocket:
          route: $disconnect

  defaultHandler:
    handler: connectionManager.default
    events:
      - websocket:
          route: $default

  # ==========================
  # Orchestrator
  # ==========================
  orchestrator:
    handler: orchestrator.handler
    timeout: 900
    iamRoleStatements:
      - Effect: Allow
        Action:
          - execute-api:ManageConnections
        Resource:
          - Fn::Sub: arn:aws:execute-api:${aws:region}:${aws:accountId}:${WebsocketsApi}/*

resources:
  Resources:
    WebsocketsApi:
      Type: AWS::ApiGatewayV2::Api
      Properties:
        Name: ${self:service}-websockets-${self:provider.stage}
        ProtocolType: WEBSOCKET
        RouteSelectionExpression: "$request.body.action"
        Description: WebSocket API for real-time workflow execution

  Outputs:
    WebsocketApiId:
      Description: WebSocket API ID
      Value:
        Ref: WebsocketsApi

    WebsocketApiUrl:
      Description: WebSocket API URL
      Value:
        Fn::Sub: wss://${WebsocketsApi}.execute-api.${self:provider.region}.amazonaws.com/${self:provider.stage}

plugins:
  - serverless-iam-roles-per-function
  - serverless-domain-manager
  - serverless-prune-plugin

package:
  individually: true
  exclude:
    - node_modules/aws-sdk/**
