org: dotportion
service: dotportion-workflow-api

custom:
  prune:
    automatic: true
    number: 2
  domains:
    dev: api-dev.dotportion.com
    prod: api.dotportion.com
  customDomain:
    domainName: ${self:custom.domains.${self:provider.stage}}
    stage: ${self:provider.stage}
    createRoute53Record: false
    basePath: "workflows"
    endpointType: "regional"
  cognito:
    userPoolArn: "arn:aws:cognito-idp:ap-south-1:074624701502:userpool/ap-south-1_25OzAmAmZ"

provider:
  name: aws
  runtime: nodejs18.x
  region: ap-south-1
  stage: ${opt:stage, 'dev'}

  iamRoleStatements:
    - Effect: Allow
      Action:
        - "ssm:GetParameter"
      Resource: "arn:aws:ssm:${self:provider.region}:${aws:accountId}:parameter/dotportion/${self:provider.stage}/*"

  environment:
    MONGO_URI: ${ssm:/dotportion/${self:provider.stage}/mongo_uri}
    MDataBase: ${self:provider.stage}
    BASE_URL: https://${self:custom.domains.${self:provider.stage}}

functions:
  createWorkflow:
    handler: create-workflow.handler
    events:
      - http:
          path: /projects/{projectId}
          method: post
          cors: true
          authorizer:
            arn: ${self:custom.cognito.userPoolArn}

  getWorkflows:
    handler: get-workflows.handler
    events:
      - http:
          path: /projects/{projectId}
          method: get
          cors: true
          authorizer:
            arn: ${self:custom.cognito.userPoolArn}

  getWorkflow:
    handler: get-workflow.handler
    events:
      - http:
          path: /{workflowId}
          method: get
          cors: true
          authorizer:
            arn: ${self:custom.cognito.userPoolArn}

  updateWorkflow:
    handler: update-workflow.handler
    events:
      - http:
          path: /{workflowId}
          method: post
          cors: true
          authorizer:
            arn: ${self:custom.cognito.userPoolArn}

  deleteWorkflow:
    handler: delete-workflow.handler
    events:
      - http:
          path: /{workflowId}
          method: delete
          cors: true
          authorizer:
            arn: ${self:custom.cognito.userPoolArn}

  toggleWorkflowDeployment:
    handler: toggle-workflow-deployment.handler
    events:
      - http:
          path: /{workflowId}/toggle-deployment
          method: get
          cors: true
          authorizer:
            arn: ${self:custom.cognito.userPoolArn}

plugins:
  - serverless-offline
  - serverless-prune-plugin
  - serverless-domain-manager

# This tells the packaging process to exclude the AWS SDK, which is already available in the Lambda environment.
package:
  individually: true
  exclude:
    - node_modules/aws-sdk/**
